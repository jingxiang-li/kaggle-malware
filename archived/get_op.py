import re
from os import listdir, path
import pickle
import gc

wd = '/media/s_ariel/HDD_1T/Kaggle/data/train'

files = listdir(wd)
regex_asm = re.compile('.*\.asm')
asm_files = [f for f in files if regex_asm.match(f) is not None]
asm_files.sort()

regex_op = re.compile(
    r'[\.\w]+:[0-9A-F]{8}\s[0-9A-F]{2}[0-9A-F\s+]*\s([a-z]+)\s.*')
regex_ignore = re.compile(r'dd|db|dw|align')
regex_ignore_header = re.compile(
    r'\.idata|\.rdata|\.data|\.bss|\.edata|DATA|BSS')

op_lists = []
i = 0

for asm in asm_files:
    op = []

    with open(path.join(wd, asm), 'r', encoding='latin-1') as f_in:
        for line in f_in:
            if regex_ignore_header.match(line) is not None:
                continue
            r0 = regex_op.match(line)
            if r0 is not None and regex_ignore.match(r0.group(1)) is None:
                op.append(r0.group(1))
    op_lists.append(op)

    if len(op_lists) >= 500:
        path_out = '/home/s_ariel/Documents/op' + str(i) + '.pickle'
        with open(path_out, 'wb') as f_out:
            pickle.dump(op_lists, f_out)
        i += 1
        op_lists = []
        print(i)
        gc.collect()


if len(op_lists) != 0:
    path_out = '/home/s_ariel/Documents/op' + str(i) + '.pickle'
    with open(path_out, 'wb') as f_out:
        pickle.dump(op_lists, f_out)
